<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CStore AI API Demo</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #333;
    }
    header {
      background: #222;
      color: #fff;
      padding: 16px 24px;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    main {
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .section {
      background: #fff;
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .section h2 {
      margin-top: 0;
      font-size: 18px;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
      margin-bottom: 12px;
    }
    .field-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px 24px;
      margin-bottom: 12px;
    }
    .field {
      display: flex;
      flex-direction: column;
      min-width: 220px;
      flex: 1 1 220px;
    }
    .field label {
      font-size: 13px;
      margin-bottom: 4px;
      color: #555;
    }
    .field input,
    .field select,
    .field textarea {
      padding: 6px 8px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .field input[type="file"] {
      padding: 4px 0;
    }
    button {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #007bff;
      color: #fff;
    }
    button:hover {
      opacity: 0.9;
    }
    .note {
      font-size: 12px;
      color: #777;
    }
    #health-result,
    #index-shelf-result,
    #model-training-result,
    #available-model-result {
      margin-top: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      white-space: pre-wrap;
      background: #f8f8f8;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #eee;
      max-height: 240px;
      overflow: auto;
    }
  </style>
</head>
<body>
<header>
  <h1>CStore AI API Demo</h1>
</header>
<main>

  <!-- Health Check -->
  <section class="section">
    <h2>/api/health</h2>
    <p class="note">Simple health check to verify the FastAPI service is running.</p>
    <button type="button" onclick="checkHealth()">Check Health</button>
    <div id="health-result"></div>
  </section>

  <!-- /api/index-shelf-yolo -->
  <section class="section">
    <h2>/api/index-shelf-yolo</h2>
    <p class="note">
      Upload a full shelf image, run YOLO detection, and index all detected objects into the vector store.
      The response includes image_id, number of detections, and number of indexed objects.
    </p>
    <form id="index-shelf-form">
      <div class="field-group">
        <div class="field">
          <label for="index-shelf-file">Shelf Image (file)</label>
          <input id="index-shelf-file" name="file" type="file" accept="image/*" required />
        </div>
        <div class="field">
          <label for="index-shelf-thresh">box_thresh (0.0 ~ 1.0)</label>
          <input id="index-shelf-thresh" name="box_thresh" type="number" step="0.01" min="0" max="1" value="0.2" />
        </div>
      </div>
      <button type="submit">Upload &amp; Index</button>
    </form>
    <div id="index-shelf-result"></div>
  </section>

  <!-- /api/ModelTraining -->
  <section class="section">
    <h2>/api/ModelTraining</h2>
    <p class="note">
      Upload a single query image (SKU image) with metadata and store it in MongoDB as base64.
    </p>
    <form id="model-training-form">
      <div class="field-group">
        <div class="field">
          <label for="mt-modelName">modelName *</label>
          <input id="mt-modelName" name="modelName" type="text" required />
        </div>
        <div class="field">
          <label for="mt-skuDescription">skuDescription *</label>
          <input id="mt-skuDescription" name="skuDescription" type="text" required />
        </div>
        <div class="field">
          <label for="mt-skuId">skuId *</label>
          <input id="mt-skuId" name="skuId" type="text" required />
        </div>
        <div class="field">
          <label for="mt-tenantId">tenantId *</label>
          <input id="mt-tenantId" name="tenantId" type="text" required />
        </div>

        <div class="field">
          <label for="mt-clientId">clientId (optional)</label>
          <input id="mt-clientId" name="clientId" type="text" />
        </div>
        <div class="field">
          <label for="mt-categoryId">categoryId (optional)</label>
          <input id="mt-categoryId" name="categoryId" type="text" />
        </div>
        <div class="field">
          <label for="mt-brandId">brandId (optional)</label>
          <input id="mt-brandId" name="brandId" type="text" />
        </div>

        <div class="field">
          <label for="mt-image">Query Image *</label>
          <input id="mt-image" name="image" type="file" accept="image/*" required />
        </div>
      </div>
      <button type="submit">Upload Query Image</button>
    </form>
    <div id="model-training-result"></div>
  </section>

  <!-- /api/AvailableModel -->
  <section class="section">
    <h2>/api/AvailableModel</h2>
    <p class="note">
      List stored single-query images (AvailableModel) filtered by metadata. Returns metadata and image_base64.
    </p>
    <form id="available-model-form">
      <div class="field-group">
        <div class="field">
          <label for="am-modelName">modelName *</label>
          <input id="am-modelName" name="modelName" type="text" required />
        </div>
        <div class="field">
          <label for="am-skuId">skuId (optional)</label>
          <input id="am-skuId" name="skuId" type="text" />
        </div>
        <div class="field">
          <label for="am-tenantId">tenantId (optional)</label>
          <input id="am-tenantId" name="tenantId" type="text" />
        </div>
        <div class="field">
          <label for="am-skuDescription">skuDescription (optional)</label>
          <input id="am-skuDescription" name="skuDescription" type="text" />
        </div>
        <div class="field">
          <label for="am-clientId">clientId (optional)</label>
          <input id="am-clientId" name="clientId" type="text" />
        </div>
        <div class="field">
          <label for="am-categoryId">categoryId (optional)</label>
          <input id="am-categoryId" name="categoryId" type="text" />
        </div>
        <div class="field">
          <label for="am-brandId">brandId (optional)</label>
          <input id="am-brandId" name="brandId" type="text" />
        </div>
      </div>
      <button type="submit">Search AvailableModel</button>
    </form>
    <div id="available-model-result"></div>
  </section>

  <!-- /api/search-visual-by-available -->
  <section class="section">
    <h2>/api/search-visual-by-available</h2>
    <p class="note">
      Use the stored AvailableModel images as queries to search across all indexed shelves.<br />
      If <code>as_zip = false</code>, returns a single combined PNG; if <code>as_zip = true</code>, returns a ZIP file with per-shelf PNGs.
    </p>

    <!-- GET form: result opens in a new tab as PNG or ZIP -->
    <form id="search-visual-form" method="get" action="/api/search-visual-by-available" target="_blank">
      <div class="field-group">
        <div class="field">
          <label for="sv-modelName">modelName *</label>
          <input id="sv-modelName" name="modelName" type="text" required />
        </div>
        <div class="field">
          <label for="sv-skuId">skuId (optional)</label>
          <input id="sv-skuId" name="skuId" type="text" />
        </div>
        <div class="field">
          <label for="sv-tenantId">tenantId (optional)</label>
          <input id="sv-tenantId" name="tenantId" type="text" />
        </div>
        <div class="field">
          <label for="sv-skuDescription">skuDescription (optional)</label>
          <input id="sv-skuDescription" name="skuDescription" type="text" />
        </div>
        <div class="field">
          <label for="sv-clientId">clientId (optional)</label>
          <input id="sv-clientId" name="clientId" type="text" />
        </div>
        <div class="field">
          <label for="sv-categoryId">categoryId (optional)</label>
          <input id="sv-categoryId" name="categoryId" type="text" />
        </div>
        <div class="field">
          <label for="sv-brandId">brandId (optional)</label>
          <input id="sv-brandId" name="brandId" type="text" />
        </div>

        <div class="field">
          <label for="sv-match_threshold">match_threshold</label>
          <input id="sv-match_threshold" name="match_threshold" type="number" step="0.01" value="0.19" />
        </div>
        <div class="field">
          <label for="sv-only_matches">only_matches</label>
          <select id="sv-only_matches" name="only_matches">
            <option value="true" >true</option>
            <option value="false" selected>false</option>
          </select>
        </div>
        <div class="field">
          <label for="sv-as_zip">as_zip</label>
          <select id="sv-as_zip" name="as_zip">
            <option value="false" selected>false (combined PNG)</option>
            <option value="true">true (ZIP)</option>
          </select>
        </div>
        <div class="field">
          <label for="sv-max_results_per_shelf">max_results_per_shelf</label>
          <input id="sv-max_results_per_shelf" name="max_results_per_shelf" type="number" value="50" />
        </div>
        <div class="field">
          <label for="sv-nms_iou_threshold">nms_iou_threshold</label>
          <input id="sv-nms_iou_threshold" name="nms_iou_threshold" type="number" step="0.05" value="0.5" />
        </div>
      </div>
      <button type="submit">Search &amp; Open Result</button>
    </form>

    <p class="note">
      This uses a plain GET form so the result opens directly in a new tab as an image or ZIP.  
      If you want to render the returned PNG in-page, you can switch to JavaScript <code>fetch</code> and handle the blob.
    </p>

  </section>

</main>

<script>
  async function checkHealth() {
    const resultEl = document.getElementById('health-result');
    resultEl.textContent = 'Loading...';
    try {
      const res = await fetch('/api/health');
      const data = await res.json();
      resultEl.textContent = JSON.stringify(data, null, 2);
    } catch (err) {
      resultEl.textContent = 'Error: ' + err;
    }
  }

  // /api/index-shelf-yolo form
  document.getElementById('index-shelf-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    const resultEl = document.getElementById('index-shelf-result');
    resultEl.textContent = 'Uploading...';

    const formData = new FormData();
    const file = document.getElementById('index-shelf-file').files[0];
    const thresh = document.getElementById('index-shelf-thresh').value || '0.2';

    if (!file) {
      resultEl.textContent = 'Please select an image file.';
      return;
    }

    formData.append('file', file);
    formData.append('box_thresh', thresh);

    try {
      const res = await fetch('/api/index-shelf-yolo', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      resultEl.textContent = JSON.stringify(data, null, 2);
    } catch (err) {
      resultEl.textContent = 'Error: ' + err;
    }
  });

  // /api/ModelTraining form
  document.getElementById('model-training-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    const resultEl = document.getElementById('model-training-result');
    resultEl.textContent = 'Uploading...';

    const formData = new FormData(e.target);

    const imageFile = document.getElementById('mt-image').files[0];
    if (!imageFile) {
      resultEl.textContent = 'Please select a query image.';
      return;
    }
    formData.set('image', imageFile);

    try {
      const res = await fetch('/api/ModelTraining', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      resultEl.textContent = JSON.stringify(data, null, 2);
    } catch (err) {
      resultEl.textContent = 'Error: ' + err;
    }
  });

  // /api/AvailableModel form
  document.getElementById('available-model-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    const resultEl = document.getElementById('available-model-result');
    resultEl.textContent = 'Searching...';

    const params = new URLSearchParams();
    const fields = [
      'modelName',
      'skuId',
      'tenantId',
      'skuDescription',
      'clientId',
      'categoryId',
      'brandId'
    ];

    fields.forEach(idSuffix => {
      const el = document.getElementById('am-' + idSuffix);
      if (el && el.value.trim() !== '') {
        params.append(idSuffix, el.value.trim());
      }
    });

    if (!params.get('modelName')) {
      resultEl.textContent = 'modelName is required.';
      return;
    }

    try {
      const res = await fetch('/api/AvailableModel?' + params.toString());
      const data = await res.json();
      resultEl.textContent = JSON.stringify(data, null, 2);
    } catch (err) {
      resultEl.textContent = 'Error: ' + err;
    }
  });
</script>
</body>
</html>
